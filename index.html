<html>

    <head>
        <title>mini-pano</title>
        <style>
            body {
                margin: 0 auto;
                width: 100%;
                height: 100%;
                overflow: hidden;
            }

            #title-area {
                text-align: center;
                padding: 40px;
            }

            #canvas-wrapper {
                margin: 50px;

            }

            canvas {
                border: 0;
                background-color: grey;

                margin: 0 auto;
                width: 500px;
                height: 300px;

            }

            .tag {
                border: 1px solid #04ffe6;
                border-radius: 30px;
                width: 30px;
                height: 30px;
                line-height: 30px;
                position: absolute;
                z-index: 9;
                animation: pulsating 1.5s ease-in infinite;
            }

            a {
                color: #1d71b8;
                background-color: white;
                border-radius: 30px;
                width: 30px;
                height: 30px;
                display: block;
                font-size: 11px;
                width: 30px;
                height: 30px;
                margin: auto;
                text-decoration: none;
                text-align: center;
            }

            @keyframes pulsating {
                0% {
                    border-width: 0px;
                    top: 0px;
                    left: 0px;
                }

                100% {
                    border-color: rgba(255, 255, 255, 0);
                    border-width: 10px;
                    top: -10px;
                    left: -10px;
                }

            }

            @media(max-width: 800px) {
                canvas {
                    width: 300px;
                }
            }
        </style>
    </head>

    <body>

        <div class="tag">
            <a href="">tag</a>
        </div>
        <div id="title-area">
            <h4>Version 1.2.0 - zoom in/out</h4>
            <p>move mouse to shift the view</p>
            <div id="canvas-wrapper">
                <canvas id="canvas"></canvas>
            </div>
        </div>

        <div style="display:none;">
            <img id="source" src="./sample.jpg" />
        </div>

        <script>

            const pixelRatio = window.devicePixelRatio;

            const image = document.getElementById("source");

            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");

            let imgWidth, imgHeight, aspect;

            let x0, y0, x1, y1, dx = 120, dy = 50, factor = 1.5;

            const tag = document.getElementsByClassName('tag')[0];
            const tagWidth = tag.offsetWidth;
            const tagX = 250, tagY = 120;
            renderTag();

            image.addEventListener("load", (e) => {
                imgWidth = image.naturalWidth;
                imgHeight = image.naturalHeight;
                aspect = imgWidth / imgHeight;
                draw(imgWidth, imgHeight, dx, dy);
            });

            function draw(imgWidth, imgHeight, dx, dy) {
                const dHeight= canvas.height / factor;
                const dWidth = dHeight * canvas.offsetWidth / canvas.offsetHeight ;
                ctx.drawImage(image, dx, dy, dWidth * pixelRatio, dHeight * pixelRatio, 0, 0, canvas.width, canvas.height);
            }

            function mousedown(e) {
                x0 = e.clientX;
                y0 = e.clientY;

                window.addEventListener('mousemove', mousemove, false);
                window.addEventListener('mouseup', mouseup, false);
            }

            function mousemove(e) {

                x1 = e.clientX;
                y1 = e.clientY;

                dx += (x0 - x1);
                dy += (y0 - y1);

                dx = Math.min(imgWidth - imgHeight, Math.max(0, dx));
                dy = Math.min(imgHeight, Math.max(0, dy));

                draw(imgWidth, imgHeight, Math.min(imgWidth, dx), dy);

                renderTag();

                x0 = x1;
                y0 = y1;

            }

            function renderTag() {

                const translateX = (tagX - dx) * factor;
                const translateY = (tagY - dy) * factor;

                if ( translateX < 0 | translateY < 0 | translateX > canvas.offsetWidth - tagWidth | translateY > + canvas.offsetHeight - tagWidth) {
                    tag.style.display = 'none';
                } else {
                    tag.style.display = 'block';
                }
                tag.style.transform = 'translate(' + (canvas.offsetLeft + translateX) + 'px,' + (canvas.offsetTop + translateY) + 'px)';
            }

            function mouseup() {
                window.removeEventListener('mousemove', mousemove, false);
            }

            function onWindowResize() {
                draw(imgWidth, imgHeight, Math.min(imgWidth, dx), dy);
                renderTag();
            }

            function zoom(e){
                e.preventDefault();
                factor += e.deltaY / 50;
                factor = Math.min(5, Math.max(factor, 1));
                console.log(factor);
                draw(imgWidth, imgHeight, Math.min(imgWidth, dx), dy);
                renderTag();
            }

            window.addEventListener('mousedown', mousedown, false);

            window.addEventListener('resize', onWindowResize, false);
            canvas.addEventListener( 'wheel', zoom, { passive: false } );

        </script>

    </body>

</html>
